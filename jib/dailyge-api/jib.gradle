def env = System.getenv("ENV")
def skipJib = project.hasProperty("skipJib") ? project.property("skipJib").toBoolean() : false
def ecrUri = System.getenv(env == 'prod' ? "PROD_ECR_URI" : "DEV_ECR_URI")
def port = env == 'prod' ? '8080' : '8081'
def profile = env == 'prod' ? 'prod' : 'dev'
def label = "dailyge-${profile}-api"

if (env != null && (env == "dev" || env == "prod") && (skipJib != null && !skipJib)) {
    jib {
        from {
            image = 'openjdk:17-jdk-slim'
        }
        to {
            image = ecrUri
            credHelper = 'ecr-login'
            tags = ['latest']
        }
        container {
            ports = [port]
            labels = [server: label]
            jvmFlags = ["-Dspring.profiles.active=${profile}", "-Dfile.encoding=UTF-8"]
            environment = ['JAVA_OPTIONS': '-Xms128m -Xmx128m']
            creationTime = 'USE_CURRENT_TIMESTAMP'
            allowInsecureRegistries = true
        }
    }
}
