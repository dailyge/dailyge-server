def env = System.getenv("ENV")
def skipJib = System.getenv("SKIP_JIB")

def ecrUri = ""
def port = ""
def profile = ""
def label = ""

if (env != null && (env == "dev" || env == "prod")) {
    ecrUri = env == "prod" ? System.getenv("PROD_ECR_URI") : System.getenv("DEV_ECR_URI")
    port = env == 'prod' ? '8080' : '8081'
    profile = env == 'prod' ? 'prod' : 'dev'
    label = "dailyge-${profile}-api"
}

if (env != null && (skipJib != null && !skipJib)) {
    jib {
        from {
            image = 'openjdk:17-jdk-slim'
        }
        to {
            image = ecrUri
            credHelper = 'ecr-login'
            tags = ['latest']
        }
        container {
            ports = [port]
            labels = [server: label]
            jvmFlags = ["-Dspring.profiles.active=${profile}", "-Dfile.encoding=UTF-8"]
            environment = ['JAVA_OPTIONS': '-Xms256m -Xmx256m']
            creationTime = 'USE_CURRENT_TIMESTAMP'
            allowInsecureRegistries = true
        }
    }
}
